# Архитектура решения

## Обзор

Решение представляет собой веб-сервис для автоматической обработки судебных документов и генерации обзоров судебной практики. Система построена на Next.js (App Router) с использованием TypeScript и OpenAI API для обработки документов через многошаговый pipeline.

---

## Высокоуровневая архитектура

### Компоненты системы

```
┌─────────────────────────────────────────────────────────────┐
│                    Frontend (Next.js)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │   Document   │  │  Processing  │  │    Review    │     │
│  │    Upload    │  │    Status    │  │   Display    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Cost Statistics Component              │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              API Routes (Next.js Server)                     │
│  ┌──────────────┐              ┌──────────────┐            │
│  │ /api/upload  │              │ /api/process │            │
│  └──────────────┘              └──────────────┘            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Core Library (lib/)                             │
│  ┌──────────────────┐  ┌──────────────────┐                 │
│  │ docx-to-markdown │  │   llm-client    │                 │
│  └──────────────────┘  └──────────────────┘                 │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              pipeline.ts (5-step pipeline)           │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              External Services                                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │              OpenAI API                               │   │
│  │  - gpt-5-mini (Steps 0, 1)                           │   │
│  │  - gpt-5 (Step 3)                                    │   │
│  │  - gpt-5.1 (Step 4)                                  │   │
│  │  - Flex mode with retry/fallback                    │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Storage (File System)                           │
│  ┌──────────────┐  ┌──────────────┐                         │
│  │   uploads/   │  │  processed/ │                         │
│  │  (DOCX files)│  │ (results by │                         │
│  │              │  │   session)  │                         │
│  └──────────────┘  └──────────────┘                         │
└─────────────────────────────────────────────────────────────┘
```

---

## Поток данных (Data Flow)

### 5-шаговый Pipeline обработки

```
Шаг 0: Извлечение правовых позиций (параллельно для всех документов)
  DOCX → Markdown → 10-level Legal Position (JSON)
  Модель: gpt-5-mini (Flex mode)
  
  Вход: DOCX файлы
  Выход: LegalPosition[] (10 уровней структурированных данных)

┌─────────────────────────────────────────────────────────────┐

Шаг 1: Локальное сжатие (параллельно для всех позиций)
  Legal Position → Case Card (компактный JSON)
  Модель: gpt-5-mini (Flex mode)
  
  Вход: LegalPosition[]
  Выход: CaseCard[] (краткие карточки дел)

┌─────────────────────────────────────────────────────────────┐

Шаг 2: Группировка (формальный шаг)
  Case Cards → Grouped Case Cards
  Без LLM вызова
  
  Вход: CaseCard[]
  Выход: CaseCard[] (все в одном кластере)

┌─────────────────────────────────────────────────────────────┐

Шаг 3: Агрегация (последовательно)
  Case Cards → Review Skeleton (структурированный JSON)
  Модель: gpt-5 (Flex mode)
  
  Вход: CaseCard[]
  Выход: ReviewSkeleton (матрица подходов, расхождения, тренды)

┌─────────────────────────────────────────────────────────────┐

Шаг 4: Генерация финального обзора (последовательно)
  Review Skeleton → Final Review (читаемый текст)
  Модель: gpt-5.1 (Flex mode)
  
  Вход: ReviewSkeleton + CaseCard[]
  Выход: Review (Markdown текст для юристов)
```

---

## Структура данных

### LegalPosition (10 уровней)
Структурированное представление правовой позиции из судебного документа:
- **Level 1**: Отрасль права, категория спора
- **Level 2**: Стороны, тип отношений
- **Level 3**: Основные и вторичные требования
- **Level 4**: Ключевые и вторичные нормы
- **Level 5**: Ключевые и спорные факты
- **Level 6**: Шаги рассуждений, особенности толкования
- **Level 7**: Краткое решение, область применения, результат
- **Level 8-10**: Риски (прямые, аналогичные, операционные)

### CaseCard
Компактная карточка дела:
- `summary`: Краткая фабула и предмет спора (1-2 строки)
- `keyFindings`: Ключевые правовые выводы (3-5 буллетов)
- `appliedNorms`: Применённые нормы (1-2 строки)
- `result`: Результат (удовлетворено/отказано/частично)

### ReviewSkeleton
Структурированный скелет обзора:
- `legalQuestion`: Правовой вопрос
- `normativeBase`: Нормативная база
- `approaches`: Массив подходов судов с описанием и примерами дел
- `discrepancies`: Расхождения в толковании, требованиях к доказательствам, оценке фактов
- `trends`: Доминирующие подходы, временные сдвиги, роль высших судов

### Review
Финальный читаемый документ в формате Markdown для практикующих юристов.

---

## Технические компоненты

### Frontend (`app/`)

#### `app/page.tsx`
Главная страница приложения:
- Управление состоянием загрузки и обработки
- Координация компонентов
- Обработка результатов pipeline

#### `app/components/DocumentUpload.tsx`
Компонент загрузки документов:
- Drag & drop интерфейс
- Валидация формата (.docx)
- Отправка файлов на `/api/upload`

#### `app/components/ProcessingStatus.tsx`
Отображение статуса обработки:
- Прогресс по шагам pipeline
- Сообщения о текущем этапе
- Обработка ошибок

#### `app/components/ReviewDisplay.tsx`
Отображение финального обзора:
- Рендеринг Markdown
- Интеграция с CostStatistics

#### `app/components/CostStatistics.tsx`
Детальная статистика расходов:
- Стоимость по каждому шагу
- Использование токенов (input, cached, output)
- Информация о модели и режиме (Flex/Standard)
- Общая статистика

### Backend API (`app/api/`)

#### `app/api/upload/route.ts`
Эндпоинт загрузки файлов:
- Приём множественных DOCX файлов
- Сохранение в `uploads/` с timestamp
- Возврат списка сохранённых файлов

#### `app/api/process/route.ts`
Эндпоинт обработки документов:
- Чтение файлов из `uploads/`
- Вызов `processDocumentsPipeline()`
- Возврат результатов с cost statistics

### Core Library (`lib/`)

#### `lib/docx-to-markdown.ts`
Конвертация DOCX в Markdown:
- Использует библиотеку `mammoth`
- Поддержка работы с файлами и буферами
- Обработка предупреждений при конвертации

#### `lib/llm-client.ts`
Клиент для работы с OpenAI API:

**Основные функции:**
- `getOpenAIClient()`: Ленивая инициализация клиента
- `callOpenAI()`: Вызов API с поддержкой:
  - Динамический выбор модели
  - Flex режим (дешевле, но может быть медленнее)
  - Retry логика с экспоненциальной задержкой (2s, 4s, 8s) для ошибок 429
  - Fallback на Standard режим при неудачных retry
  - Fallback на `gpt-4o` при недоступности модели
  - Расчёт стоимости на основе использования токенов

**Ценообразование:**
- `MODEL_PRICING`: Стандартные цены для моделей
- `MODEL_PRICING_FLEX`: Цены для Flex режима (в 2 раза дешевле)
- Отдельный учёт input, cached input, output токенов

**Возвращаемые данные:**
- `content`: Текст ответа
- `usage`: Статистика токенов
- `cost`: Детализация расходов
- `usedFlex`: Фактически использовался ли Flex режим
- `fallbackToStandard`: Произошёл ли fallback на Standard

#### `lib/pipeline.ts`
Основной pipeline обработки документов:

**Функции шагов:**
- `processDocumentStep0()`: DOCX → Markdown → Legal Position
- `processStep1()`: Legal Position → Case Card
- `processStep2()`: Формальная группировка
- `processStep3()`: Case Cards → Review Skeleton
- `processStep4()`: Review Skeleton → Final Review

**`processDocumentsPipeline()`:**
- Оркестрация всех шагов
- Параллельная обработка на шагах 0 и 1
- Последовательная обработка на шагах 3 и 4
- Сбор статистики расходов по каждому шагу
- Callback для отслеживания прогресса
- Сохранение промежуточных результатов

**Сохранение результатов (`saveResults()`):**
- Создание директории по timestamp сессии
- Сохранение для каждого документа:
  - `markdown.md`
  - `legal-position.json`
  - `case-card.json`
- Сохранение `review-skeleton.json` и `review.md`

---

## Оптимизация затрат

### Выбор моделей по шагам

| Шаг | Модель      | Обоснование                                    |
|-----|-------------|------------------------------------------------|
| 0   | gpt-5-mini  | Простое извлечение структурированных данных   |
| 1   | gpt-5-mini  | Простое сжатие структурированных данных       |
| 2   | -           | Формальный шаг, без LLM                        |
| 3   | gpt-5       | Сложная аналитика и агрегация                  |
| 4   | gpt-5.1     | Генерация финального текста высокого качества |

### Flex режим

Все шаги используют Flex режим для снижения затрат:
- **Стоимость**: В 2 раза дешевле Standard режима
- **Латентность**: Может быть выше
- **Надёжность**: Может быть недоступен (ошибка 429)

### Механизмы надёжности

1. **Retry с экспоненциальной задержкой**:
   - 3 попытки с задержками 2s, 4s, 8s
   - Только для ошибок 429 Resource Unavailable

2. **Fallback на Standard режим**:
   - При исчерпании retry попыток
   - При других ошибках в Flex режиме

3. **Fallback на другую модель**:
   - При недоступности указанной модели (404)
   - Используется `gpt-4o` как резервная модель

---

## Хранение данных

### Структура директорий

```
uploads/
  ├── {timestamp}-{originalFileName}.docx
  └── ...

processed/
  └── {sessionTimestamp}/
      ├── {documentId}/
      │   ├── markdown.md
      │   ├── legal-position.json
      │   └── case-card.json
      ├── review-skeleton.json
      └── review.md
```

### Формат сохранения

- **Markdown**: Промежуточные результаты конвертации
- **JSON**: Структурированные данные (Legal Position, Case Card, Review Skeleton)
- **Markdown**: Финальный обзор для чтения

---

## Промпты (`prompts/`)

Система использует разделение промптов на SYSTEM и USER части:

- **`step0-prompt.md`**: Извлечение 10-уровневой правовой позиции
- **`step1-prompt.md`**: Сжатие позиции в карточку дела
- **`step3-prompt.md`**: Агрегация карточек в скелет обзора
- **`step4-prompt.md`**: Генерация финального обзора

Формат промптов:
```markdown
## 🟦 **SYSTEM PROMPT**

{системный промпт}

---

## 🟩 **USER PROMPT**

{пользовательский промпт}
```

---

## Зависимости

### Основные библиотеки

- **Next.js 16.0.7**: React framework с App Router
- **TypeScript 5.9.3**: Типизация
- **OpenAI SDK 6.10.0**: Работа с OpenAI API
- **Mammoth 1.11.0**: Конвертация DOCX → Markdown
- **Formidable 3.5.4**: Обработка загрузки файлов
- **Tailwind CSS 4.1.17**: Стилизация UI

---

## Обработка ошибок

### Уровни обработки ошибок

1. **Уровень компонента**: Отображение ошибок пользователю
2. **Уровень API**: Валидация входных данных, обработка ошибок pipeline
3. **Уровень Pipeline**: Частичные результаты при ошибках отдельных документов
4. **Уровень LLM Client**: Retry, fallback, логирование

### Стратегия восстановления

- Продолжение обработки при ошибках отдельных документов
- Сохранение частичных результатов
- Детальное логирование для отладки

---

## Масштабируемость

### Текущие ограничения

- Обработка файлов в памяти (буферы)
- Файловая система для хранения
- Синхронная обработка на шагах 3-4

### Потенциальные улучшения

- Очередь задач для асинхронной обработки
- База данных для хранения результатов
- Кэширование промежуточных результатов
- Batch API для массовой обработки
- Server-Sent Events для real-time прогресса

---

## Безопасность

### Текущие меры

- Валидация формата файлов (.docx)
- Ограничение размера запроса (Next.js по умолчанию)
- Переменные окружения для API ключей

### Рекомендации

- Ограничение размера файлов
- Санитизация имён файлов
- Rate limiting для API endpoints
- Аутентификация и авторизация пользователей

